<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enzyme assay analysis</title>
    <style>
      body {
        display: grid;
        place-items: center;
        min-height: 100vh;
        margin: 0;
        font-family: system-ui, sans-serif;
        background: #f5f7fa;
        color: #555;
      }
      h1 {
        font-size: clamp(2rem, 5vw, 3rem);
        margin: 0;
      }
    </style>
  </head>
  <body>
    <h1>üöß Site under construction üöß</h1>
    <div style="margin-bottom: 1em; font-weight: bold; font-size: 1.2em;">Data input (from 96-well plate)</div>
    <div id="plate"></div>
    <div style="margin-top: 2em; margin-bottom: 0.5em; font-weight: bold; font-size: 1.1em;">Output (Max Lysis Rate)</div>
    <div id="output"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.js"></script>
    <script>
      const container = document.getElementById('plate');
      const colHeaders = [
        'Well ID',
        ...Array.from({length: 30}, (_, i) => `${i+1} min`)
      ];
      const hot = new Handsontable(container, {
        data: Array.from({length: 96}, () => Array(31).fill('')),
        colHeaders: colHeaders,
        rowHeaders: i => `R${i+1}`,
        licenseKey: 'non-commercial-and-evaluation',
        width: '100%',
        height: 600,
        afterChange: updateOutputTable,
      });

      // ËæìÂá∫Ë°®Ê†º
      const outputContainer = document.getElementById('output');
      const outputHot = new Handsontable(outputContainer, {
        data: Array.from({length: 8}, () => Array(12).fill('')),
        colHeaders: Array.from({length: 12}, (_, i) => i+1),
        rowHeaders: i => String.fromCharCode(65 + i), // A~H
        readOnly: true,
        licenseKey: 'non-commercial-and-evaluation',
        width: '100%',
        height: 300,
      });

      // Ê†πÊçÆWell IDÊò†Â∞ÑÂà∞ËæìÂá∫Ë°®Ê†ºÁöÑË°åÂàó
      function wellIdToIndices(wellId) {
        // Well ID ‰æãÂ¶Ç "A1", "H12"
        if (!wellId || typeof wellId !== 'string') return null;
        const match = wellId.match(/^([A-Ha-h])(\d{1,2})$/);
        if (!match) return null;
        const row = match[1].toUpperCase().charCodeAt(0) - 65; // 0~7
        const col = parseInt(match[2], 10) - 1; // 0~11
        if (row < 0 || row > 7 || col < 0 || col > 11) return null;
        return {row, col};
      }

      function updateOutputTable() {
        // Ê∏ÖÁ©∫ËæìÂá∫Ë°®Ê†º
        const outputData = Array.from({length: 8}, () => Array(12).fill(''));
        const inputData = hot.getData();
        for (let i = 0; i < inputData.length; i++) {
          const row = inputData[i];
          const wellId = row[0];
          const indices = wellIdToIndices(wellId);
          if (indices) {
            // ÂèñËØ•Ë°åÈô§Well IDÂ§ñÁöÑÊúÄÂ§ßÂÄºÔºàÂøΩÁï•Á©∫ÂÄºÂíåÈùûÊï∞Â≠óÔºâ
            const values = row.slice(1).map(Number).filter(v => !isNaN(v));
            if (values.length > 0) {
              outputData[indices.row][indices.col] = Math.max(...values);
            }
          }
        }
        outputHot.loadData(outputData);
      }
    </script>
  </body>
</html>
